
name: Java CI/CD Pipeline

# 1. Triggers: This workflow runs on any push to the 'main' branch
on:
  push:
    branches: [ "main" ]

jobs:
  # --------------------------------------------------------------------
  # JOB 1: Build and Test the 'test-management-api'
  # --------------------------------------------------------------------
  build-api:
    name: Build & Test API
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build and Test API with Maven
        run: mvn -B test --file test-management-api/pom.xml

  # --------------------------------------------------------------------
  # JOB 2: Build and Test the 'test-runner-worker'
  # --------------------------------------------------------------------
  build-worker:
    name: Build & Test Worker
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build and Test Worker with Maven
        run: mvn -B test --file test-runner-worker/pom.xml

  # --------------------------------------------------------------------
  # JOB 3: Build and Push Docker images
  # This job 'depends on' the build jobs finishing successfully
  # --------------------------------------------------------------------
  build-docker-images:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    needs: [build-api, build-worker] # Ensures this runs only after builds succeed
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Add Docker's QEMU build-x tools for multi-platform support
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # Set up Docker Buildx for advanced features
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Login to your Docker registry (e.g., Docker Hub)
      # You MUST create 'DOCKERHUB_USERNAME' and 'DOCKERHUB_TOKEN'
      # as encrypted secrets in your GitHub repository settings.
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Build and push the API image
      - name: Build and Push API Image
        uses: docker/build-push-action@v5
        with:
          context: ./test-management-api
          file: ./test-management-api/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/test-management-api:latest

      # Build and push the Worker image
      - name: Build and Push Worker Image
        uses: docker/build-push-action@v5
        with:
          context: ./test-runner-worker
          file: ./test-runner-worker/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/test-runner-worker:latest

      # Build and push the Dashboard image
      - name: Build and Push Dashboard Image
        uses: docker/build-push-action@v5
        with:
          context: ./dashboard-ui
          file: ./dashboard-ui/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/dashboard-ui:latest

  # --------------------------------------------------------------------
  # JOB 4: (Placeholder) Deployment
  # This is where you would deploy to a server (e.g., AWS, Azure, GCP)
  # --------------------------------------------------------------------
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build-docker-images # Depends on the Docker images being pushed
    steps:
      - name: Deploy to server
        run: |
          echo "This step is a placeholder."
          echo "Here you would typically SSH into a server and run 'docker-compose pull'"
          echo "or update a Kubernetes deployment to use the 'latest' tags."